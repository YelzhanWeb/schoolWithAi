<!DOCTYPE html>
<html lang="ru">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>–†–µ–¥–∞–∫—Ç–æ—Ä –∫—É—Ä—Å–∞ - OqysAI</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/axios/dist/axios.min.js"></script>
</head>

<body class="bg-gray-50">
    <nav class="bg-white shadow-md">
        <div class="max-w-7xl mx-auto px-4 py-4">
            <div class="flex items-center justify-between">
                <h1 class="text-2xl font-bold text-indigo-600">üéì OqysAI (–£—á–∏—Ç–µ–ª—å)</h1>
                <div class="flex items-center space-x-2">
                    <span class="text-gray-700" id="userName">...</span>
                    <button onclick="logout()" class="text-red-600 hover:text-red-700">–í—ã–π—Ç–∏</button>
                </div>
            </div>
        </div>
    </nav>

    <div class="max-w-4xl mx-auto px-4 py-8">
        <a href="./teacher-courses.html" class="text-gray-600 hover:text-indigo-600 mb-6 inline-block">
            ‚Üê –ù–∞–∑–∞–¥ –∫ –∫—É—Ä—Å–∞–º
        </a>

        <div class="bg-white rounded-lg shadow-lg p-8">
            <h1 id="formTitle" class="text-3xl font-bold text-gray-800 mb-6">–°–æ–∑–¥–∞–Ω–∏–µ –Ω–æ–≤–æ–≥–æ –∫—É—Ä—Å–∞</h1>

            <form id="courseForm">
                <div class="mb-4">
                    <label class="block text-gray-700 font-semibold mb-2" for="title">–ù–∞–∑–≤–∞–Ω–∏–µ –∫—É—Ä—Å–∞</label>
                    <input type="text" id="title" required
                        class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-indigo-500"
                        placeholder="–ù–∞–ø—Ä–∏–º–µ—Ä, '–û—Å–Ω–æ–≤—ã –∞–ª–≥–µ–±—Ä—ã'">
                </div>

                <div class="mb-4">
                    <label class="block text-gray-700 font-semibold mb-2" for="subject">–ü—Ä–µ–¥–º–µ—Ç</label>
                    <input type="text" id="subject" required
                        class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-indigo-500"
                        placeholder="–ù–∞–ø—Ä–∏–º–µ—Ä, 'mathematics'">
                </div>

                <div class="mb-6">
                    <label class="block text-gray-700 font-semibold mb-2" for="description">–û–ø–∏—Å–∞–Ω–∏–µ –∫—É—Ä—Å–∞</label>
                    <textarea id="description" rows="4"
                        class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-indigo-500"
                        placeholder="–ö—Ä–∞—Ç–∫–æ–µ –æ–ø–∏—Å–∞–Ω–∏–µ —Ç–æ–≥–æ, —á–µ–º—É –Ω–∞—É—á–∞—Ç—Å—è —É—á–µ–Ω–∏–∫–∏"></textarea>
                </div>

                <div class="grid grid-cols-2 gap-6 mb-6">
                    <div>
                        <label class="block text-gray-700 font-semibold mb-2" for="difficulty">–°–ª–æ–∂–Ω–æ—Å—Ç—å</label>
                        <select id="difficulty" required
                            class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-indigo-500">
                            <option value="1">1 - –õ–µ–≥–∫–æ</option>
                            <option value="2">2 - –ù–∞—á–∞–ª—å–Ω—ã–π</option>
                            <option value="3" selected>3 - –°—Ä–µ–¥–Ω–∏–π</option>
                            <option value="4">4 - –°–ª–æ–∂–Ω—ã–π</option>
                            <option value="5">5 - –≠–∫—Å–ø–µ—Ä—Ç</option>
                        </select>
                    </div>
                    <div>
                        <label class="block text-gray-700 font-semibold mb-2" for="ageGroup">–í–æ–∑—Ä–∞—Å—Ç–Ω–∞—è –≥—Ä—É–ø–ø–∞</label>
                        <select id="ageGroup" required
                            class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-indigo-500">
                            <option value="junior">–ú–ª–∞–¥—à–∏–µ (1-4)</option>
                            <option value="middle" selected>–°—Ä–µ–¥–Ω–∏–µ (5-8)</option>
                            <option value="senior">–°—Ç–∞—Ä—à–∏–µ (9-11)</option>
                        </select>
                    </div>
                </div>

                <div id="errorMessage" class="hidden mb-4 p-3 bg-red-100 text-red-700 rounded-lg"></div>

                <button type="submit" id="submitButton"
                    class="w-full bg-indigo-600 text-white py-3 rounded-lg font-semibold hover:bg-indigo-700 transition">
                    –°–æ–∑–¥–∞—Ç—å –∫—É—Ä—Å
                </button>
            </form>
        </div>
    </div>

    <script src="js/api.js"></script>
    <script src="js/auth.js"></script>
    <script src="js/main.js"></script>
    <script>
        // –ó–∞—â–∏—Ç–∞ —Å—Ç—Ä–∞–Ω–∏—Ü—ã
        if (!protectPage() || !isTeacher()) {
            logout();
        }

        const user = getCurrentUser();
        document.getElementById('userName').textContent = user.full_name;

        const urlParams = new URLSearchParams(window.location.search);
        const courseId = urlParams.get('id');
        const isEditMode = Boolean(courseId);

        const form = document.getElementById('courseForm');
        const titleEl = document.getElementById('title');
        const subjectEl = document.getElementById('subject');
        const descriptionEl = document.getElementById('description');
        const difficultyEl = document.getElementById('difficulty');
        const ageGroupEl = document.getElementById('ageGroup');
        const errorEl = document.getElementById('errorMessage');

        // –ó–∞–≥—Ä—É–∑–∫–∞ –¥–∞–Ω–Ω—ã—Ö, –µ—Å–ª–∏ —ç—Ç–æ —Ä–µ–∂–∏–º —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏—è
        async function loadCourseForEdit() {
            if (!isEditMode) return;

            document.getElementById('formTitle').textContent = '–†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ –∫—É—Ä—Å–∞';
            document.getElementById('submitButton').textContent = '–°–æ—Ö—Ä–∞–Ω–∏—Ç—å –∏–∑–º–µ–Ω–µ–Ω–∏—è';

            try {
                // –ú—ã –º–æ–∂–µ–º –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å –ø—É–±–ª–∏—á–Ω—ã–π API –¥–ª—è –ø–æ–ª—É—á–µ–Ω–∏—è –¥–∞–Ω–Ω—ã—Ö –∫—É—Ä—Å–∞
                const response = await API.courses.getById(courseId);
                const course = response.data.course;

                // –ó–∞–ø–æ–ª–Ω—è–µ–º —Ñ–æ—Ä–º—É
                titleEl.value = course.title;
                subjectEl.value = course.subject;
                descriptionEl.value = course.description;
                difficultyEl.value = course.difficulty_level;
                ageGroupEl.value = course.age_group;

            } catch (error) {
                console.error('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –∫—É—Ä—Å–∞:', error);
                errorEl.textContent = '–ù–µ —É–¥–∞–ª–æ—Å—å –∑–∞–≥—Ä—É–∑–∏—Ç—å –¥–∞–Ω–Ω—ã–µ –∫—É—Ä—Å–∞. –í—ã –±—É–¥–µ—Ç–µ –ø–µ—Ä–µ–Ω–∞–ø—Ä–∞–≤–ª–µ–Ω—ã.';
                errorEl.classList.remove('hidden');
                setTimeout(() => window.location.href = './teacher-courses.html', 2000);
            }
        }

        // –û–±—Ä–∞–±–æ—Ç–∫–∞ –æ—Ç–ø—Ä–∞–≤–∫–∏ —Ñ–æ—Ä–º—ã
        form.addEventListener('submit', async (e) => {
            e.preventDefault();
            errorEl.classList.add('hidden');

            const courseData = {
                title: titleEl.value,
                subject: subjectEl.value,
                description: descriptionEl.value,
                difficulty_level: parseInt(difficultyEl.value),
                age_group: ageGroupEl.value,
            };

            try {
                if (isEditMode) {
                    // –†–ï–ñ–ò–ú –û–ë–ù–û–í–õ–ï–ù–ò–Ø
                    await API.teacher.updateCourse(courseId, courseData);
                    showToast('–ö—É—Ä—Å —É—Å–ø–µ—à–Ω–æ –æ–±–Ω–æ–≤–ª–µ–Ω!');
                } else {
                    // –†–ï–ñ–ò–ú –°–û–ó–î–ê–ù–ò–Ø
                    await API.teacher.createCourse(courseData);
                    showToast('–ö—É—Ä—Å —É—Å–ø–µ—à–Ω–æ —Å–æ–∑–¥–∞–Ω!');
                }

                // –í–æ–∑–≤—Ä–∞—â–∞–µ–º—Å—è –∫ —Å–ø–∏—Å–∫—É –∫—É—Ä—Å–æ–≤
                window.location.href = './teacher-courses.html';

            } catch (error) {
                console.error('–û—à–∏–±–∫–∞ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è:', error);
                errorEl.textContent = error.response?.data?.error || '–ü—Ä–æ–∏–∑–æ—à–ª–∞ –æ—à–∏–±–∫–∞ –ø—Ä–∏ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏–∏';
                errorEl.classList.remove('hidden');
            }
        });

        loadCourseForEdit();
    </script>
</body>

</html>