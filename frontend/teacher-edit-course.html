[file: yelzhanweb/schoolwithai/schoolWithAi-5f9dcd3ea3f5dbe64c75caca2db1c300bc042f50/frontend/teacher-edit-course.html]
<!DOCTYPE html>
<html lang="ru">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>–†–µ–¥–∞–∫—Ç–æ—Ä –∫—É—Ä—Å–∞ - OqysAI</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/axios/dist/axios.min.js"></script>
</head>

<body class="bg-gray-50">
    <nav class="bg-white shadow-md">
        <div class="max-w-7xl mx-auto px-4 py-4">
            <div class="flex items-center justify-between">
                <h1 class="text-2xl font-bold text-indigo-600">üéì OqysAI (–£—á–∏—Ç–µ–ª—å)</h1>
                <div class="flex items-center space-x-2">
                    <span class="text-gray-700" id="userName">...</span>
                    <button onclick="logout()" class="text-red-600 hover:text-red-700">–í—ã–π—Ç–∏</button>
                </div>
            </div>
        </div>
    </nav>

    <div class="max-w-4xl mx-auto px-4 py-8">
        <a href="./teacher-courses.html" class="text-gray-600 hover:text-indigo-600 mb-6 inline-block">
            ‚Üê –ù–∞–∑–∞–¥ –∫ –∫—É—Ä—Å–∞–º
        </a>

        <div class="bg-white rounded-lg shadow-lg p-8">
            <h1 id="formTitle" class="text-3xl font-bold text-gray-800 mb-6">–°–æ–∑–¥–∞–Ω–∏–µ –Ω–æ–≤–æ–≥–æ –∫—É—Ä—Å–∞</h1>

            <form id="courseForm">
                <div class="mb-4">
                    <label class="block text-gray-700 font-semibold mb-2" for="title">–ù–∞–∑–≤–∞–Ω–∏–µ –∫—É—Ä—Å–∞</label>
                    <input type="text" id="title" required
                        class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-indigo-500"
                        placeholder="–ù–∞–ø—Ä–∏–º–µ—Ä, '–û—Å–Ω–æ–≤—ã –∞–ª–≥–µ–±—Ä—ã'">
                </div>

                <div class="mb-4">
                    <label class="block text-gray-700 font-semibold mb-2" for="subject">–ü—Ä–µ–¥–º–µ—Ç</label>
                    <input type="text" id="subject" required
                        class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-indigo-500"
                        placeholder="–ù–∞–ø—Ä–∏–º–µ—Ä, 'mathematics'">
                </div>

                <div class="mb-6">
                    <label class="block text-gray-700 font-semibold mb-2" for="description">–û–ø–∏—Å–∞–Ω–∏–µ –∫—É—Ä—Å–∞</label>
                    <textarea id="description" rows="4"
                        class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-indigo-500"
                        placeholder="–ö—Ä–∞—Ç–∫–æ–µ –æ–ø–∏—Å–∞–Ω–∏–µ —Ç–æ–≥–æ, —á–µ–º—É –Ω–∞—É—á–∞—Ç—Å—è —É—á–µ–Ω–∏–∫–∏"></textarea>
                </div>

                <div class="grid grid-cols-2 gap-6 mb-6">
                    <div>
                        <label class="block text-gray-700 font-semibold mb-2" for="difficulty">–°–ª–æ–∂–Ω–æ—Å—Ç—å</label>
                        <select id="difficulty" required
                            class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-indigo-500">
                            <option value="1">1 - –õ–µ–≥–∫–æ</option>
                            <option value="2">2 - –ù–∞—á–∞–ª—å–Ω—ã–π</option>
                            <option value="3" selected>3 - –°—Ä–µ–¥–Ω–∏–π</option>
                            <option value="4">4 - –°–ª–æ–∂–Ω—ã–π</option>
                            <option value="5">5 - –≠–∫—Å–ø–µ—Ä—Ç</option>
                        </select>
                    </div>
                    <div>
                        <label class="block text-gray-700 font-semibold mb-2" for="ageGroup">–í–æ–∑—Ä–∞—Å—Ç–Ω–∞—è –≥—Ä—É–ø–ø–∞</label>
                        <select id="ageGroup" required
                            class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-indigo-500">
                            <option value="junior">–ú–ª–∞–¥—à–∏–µ (1-4)</option>
                            <option value="middle" selected>–°—Ä–µ–¥–Ω–∏–µ (5-8)</option>
                            <option value="senior">–°—Ç–∞—Ä—à–∏–µ (9-11)</option>
                        </select>
                    </div>
                </div>

                <div id="errorMessage" class="hidden mb-4 p-3 bg-red-100 text-red-700 rounded-lg"></div>

                <button type="submit" id="submitButton"
                    class="w-full bg-indigo-600 text-white py-3 rounded-lg font-semibold hover:bg-indigo-700 transition">
                    –°–æ–∑–¥–∞—Ç—å –∫—É—Ä—Å
                </button>
            </form>

            <div id="modulesSection" class="hidden mt-10 pt-6 border-t">
                <h2 class="text-2xl font-bold text-gray-800 mb-4">–ú–æ–¥—É–ª–∏ –∫—É—Ä—Å–∞</h2>

                <div id="modulesList" class="mb-6">
                </div>

                <h3 class="text-xl font-semibold text-gray-700 mb-3">–î–æ–±–∞–≤–∏—Ç—å –Ω–æ–≤—ã–π –º–æ–¥—É–ª—å</h3>
                <form id="addModuleForm" class="flex items-end gap-4 p-4 bg-gray-50 rounded-lg">
                    <div class="flex-grow">
                        <label class="block text-sm font-medium text-gray-600 mb-1" for="newModuleTitle">–ù–∞–∑–≤–∞–Ω–∏–µ
                            –º–æ–¥—É–ª—è</label>
                        <input type="text" id="newModuleTitle" required
                            class="w-full px-3 py-2 border border-gray-300 rounded-lg">
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-600 mb-1" for="newModuleOrder">–ü–æ—Ä—è–¥–æ–∫</label>
                        <input type="number" id="newModuleOrder" required value="1" min="1"
                            class="w-20 px-3 py-2 border border-gray-300 rounded-lg">
                    </div>
                    <button type="submit"
                        class="px-5 py-2 bg-indigo-600 text-white rounded-lg hover:bg-indigo-700 font-semibold">
                        + –î–æ–±–∞–≤–∏—Ç—å
                    </button>
                </form>
            </div>
        </div>
    </div>

    <script src="js/api.js"></script>
    <script src="js/auth.js"></script>
    <script src="js/main.js"></script>
    <script>
        // –ó–∞—â–∏—Ç–∞ —Å—Ç—Ä–∞–Ω–∏—Ü—ã
        if (!protectPage() || !isTeacher()) {
            logout();
        }

        const user = getCurrentUser();
        document.getElementById('userName').textContent = user.full_name;

        const urlParams = new URLSearchParams(window.location.search);
        const courseId = urlParams.get('id');
        const isEditMode = Boolean(courseId);

        const form = document.getElementById('courseForm');
        const titleEl = document.getElementById('title');
        const subjectEl = document.getElementById('subject');
        const descriptionEl = document.getElementById('description');
        const difficultyEl = document.getElementById('difficulty');
        const ageGroupEl = document.getElementById('ageGroup');
        const errorEl = document.getElementById('errorMessage');

        // –ù–û–í–´–ï –ü–ï–†–ï–ú–ï–ù–ù–´–ï
        let courseModules = []; // –ë—É–¥–µ–º —Ö—Ä–∞–Ω–∏—Ç—å –º–æ–¥—É–ª–∏ –∑–¥–µ—Å—å
        const modulesSection = document.getElementById('modulesSection');
        const modulesListEl = document.getElementById('modulesList');
        const addModuleForm = document.getElementById('addModuleForm');


        // –ó–∞–≥—Ä—É–∑–∫–∞ –¥–∞–Ω–Ω—ã—Ö, –µ—Å–ª–∏ —ç—Ç–æ —Ä–µ–∂–∏–º —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏—è
        async function loadCourseForEdit() {
            if (!isEditMode) return;

            document.getElementById('formTitle').textContent = '–†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ –∫—É—Ä—Å–∞';
            document.getElementById('submitButton').textContent = '–°–æ—Ö—Ä–∞–Ω–∏—Ç—å –∏–∑–º–µ–Ω–µ–Ω–∏—è';

            try {
                // –ú—ã –º–æ–∂–µ–º –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å –ø—É–±–ª–∏—á–Ω—ã–π API –¥–ª—è –ø–æ–ª—É—á–µ–Ω–∏—è –¥–∞–Ω–Ω—ã—Ö –∫—É—Ä—Å–∞
                const response = await API.courses.getById(courseId);
                const course = response.data.course;

                // –ù–û–í–û–ï: –°–æ—Ö—Ä–∞–Ω—è–µ–º –∏ –æ—Ç–æ–±—Ä–∞–∂–∞–µ–º –º–æ–¥—É–ª–∏
                courseModules = response.data.modules || [];

                // –ó–∞–ø–æ–ª–Ω—è–µ–º —Ñ–æ—Ä–º—É
                titleEl.value = course.title;
                subjectEl.value = course.subject;
                descriptionEl.value = course.description;
                difficultyEl.value = course.difficulty_level;
                ageGroupEl.value = course.age_group;

                // –ù–û–í–û–ï: –ü–æ–∫–∞–∑—ã–≤–∞–µ–º —Å–µ–∫—Ü–∏—é –º–æ–¥—É–ª–µ–π –∏ —Ä–µ–Ω–¥–µ—Ä–∏–º –∏—Ö
                modulesSection.classList.remove('hidden');
                displayModules();

                // –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º —Å–ª–µ–¥—É—é—â–∏–π –ø–æ –ø–æ—Ä—è–¥–∫—É –∏–Ω–¥–µ–∫—Å –¥–ª—è –Ω–æ–≤–æ–≥–æ –º–æ–¥—É–ª—è
                const nextOrder = courseModules.length > 0
                    ? Math.max(...courseModules.map(m => m.order_index)) + 1
                    : 1;
                document.getElementById('newModuleOrder').value = nextOrder;


            } catch (error) {
                console.error('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –∫—É—Ä—Å–∞:', error);
                errorEl.textContent = '–ù–µ —É–¥–∞–ª–æ—Å—å –∑–∞–≥—Ä—É–∑–∏—Ç—å –¥–∞–Ω–Ω—ã–µ –∫—É—Ä—Å–∞. –í—ã –±—É–¥–µ—Ç–µ –ø–µ—Ä–µ–Ω–∞–ø—Ä–∞–≤–ª–µ–Ω—ã.';
                errorEl.classList.remove('hidden');
                setTimeout(() => window.location.href = './teacher-courses.html', 2000);
            }
        }

        // –ù–û–í–ê–Ø –§–£–ù–ö–¶–ò–Ø: –û—Ç–æ–±—Ä–∞–∂–µ–Ω–∏–µ —Å–ø–∏—Å–∫–∞ –º–æ–¥—É–ª–µ–π
        function displayModules() {
            if (courseModules.length === 0) {
                modulesListEl.innerHTML = '<p class="text-gray-500 mb-4">–ú–æ–¥—É–ª–µ–π –ø–æ–∫–∞ –Ω–µ—Ç. –î–æ–±–∞–≤—å—Ç–µ –ø–µ—Ä–≤—ã–π.</p>';
                return;
            }

            // –°–æ—Ä—Ç–∏—Ä—É–µ–º –º–æ–¥—É–ª–∏ –ø–æ order_index
            courseModules.sort((a, b) => a.order_index - b.order_index);

            modulesListEl.innerHTML = `
                <div class="border rounded-lg mb-6">
                    <ul class="divide-y divide-gray-200">
                        ${courseModules.map(m => `
                            <li class="p-4 flex justify-between items-center">
                                <div>
                                    <strong class="text-lg text-gray-800">${m.order_index}. ${m.title}</strong>
                                    <p class="text-sm text-gray-600">${m.description || '–ù–µ—Ç –æ–ø–∏—Å–∞–Ω–∏—è'}</p>
                                </div>
                                <button class="text-blue-600 hover:text-blue-800">
                                    –†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å
                                </button>
                            </li>
                        `).join('')}
                    </ul>
                </div>
            `;
        }

        // –û–±—Ä–∞–±–æ—Ç–∫–∞ –æ—Ç–ø—Ä–∞–≤–∫–∏ —Ñ–æ—Ä–º—ã (–û–°–ù–û–í–ù–û–ô)
        form.addEventListener('submit', async (e) => {
            e.preventDefault();
            errorEl.classList.add('hidden');

            const courseData = {
                title: titleEl.value,
                subject: subjectEl.value,
                description: descriptionEl.value,
                difficulty_level: parseInt(difficultyEl.value),
                age_group: ageGroupEl.value,
            };

            try {
                if (isEditMode) {
                    // –†–ï–ñ–ò–ú –û–ë–ù–û–í–õ–ï–ù–ò–Ø
                    await API.teacher.updateCourse(courseId, courseData);
                    showToast('–ö—É—Ä—Å —É—Å–ø–µ—à–Ω–æ –æ–±–Ω–æ–≤–ª–µ–Ω!');
                } else {
                    // –†–ï–ñ–ò–ú –°–û–ó–î–ê–ù–ò–Ø
                    await API.teacher.createCourse(courseData);
                    showToast('–ö—É—Ä—Å —É—Å–ø–µ—à–Ω–æ —Å–æ–∑–¥–∞–Ω!');
                }

                // –í–æ–∑–≤—Ä–∞—â–∞–µ–º—Å—è –∫ —Å–ø–∏—Å–∫—É –∫—É—Ä—Å–æ–≤
                window.location.href = './teacher-courses.html';

            } catch (error) {
                console.error('–û—à–∏–±–∫–∞ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è:', error);
                errorEl.textContent = error.response?.data?.error || '–ü—Ä–æ–∏–∑–æ—à–ª–∞ –æ—à–∏–±–∫–∞ –ø—Ä–∏ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏–∏';
                errorEl.classList.remove('hidden');
            }
        });

        // –ù–û–í–´–ô –û–ë–†–ê–ë–û–¢–ß–ò–ö: –î–æ–±–∞–≤–ª–µ–Ω–∏–µ –º–æ–¥—É–ª—è
        addModuleForm.addEventListener('submit', async (e) => {
            e.preventDefault();

            const titleInput = document.getElementById('newModuleTitle');
            const orderInput = document.getElementById('newModuleOrder');

            const moduleData = {
                course_id: parseInt(courseId),
                title: titleInput.value,
                order_index: parseInt(orderInput.value),
                description: "" // –û–ø–∏—Å–∞–Ω–∏–µ –º–æ–∂–Ω–æ –±—É–¥–µ—Ç –¥–æ–±–∞–≤–∏—Ç—å –ø—Ä–∏ —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏–∏
            };

            if (!moduleData.title || isNaN(moduleData.order_index)) {
                alert('–ó–∞–ø–æ–ª–Ω–∏—Ç–µ –Ω–∞–∑–≤–∞–Ω–∏–µ –∏ –ø–æ—Ä—è–¥–æ–∫ –º–æ–¥—É–ª—è.');
                return;
            }

            try {
                const response = await API.teacher.createModule(moduleData);

                showToast('–ú–æ–¥—É–ª—å —É—Å–ø–µ—à–Ω–æ —Å–æ–∑–¥–∞–Ω!');
                courseModules.push(response.data.module); // –ë—ç–∫–µ–Ω–¥ –≤–æ–∑–≤—Ä–∞—â–∞–µ—Ç —Å–æ–∑–¥–∞–Ω–Ω—ã–π –º–æ–¥—É–ª—å
                displayModules(); // –û–±–Ω–æ–≤–ª—è–µ–º —Å–ø–∏—Å–æ–∫

                // –û—á–∏—â–∞–µ–º —Ñ–æ—Ä–º—É –∏ —Å—Ç–∞–≤–∏–º —Å–ª–µ–¥—É—é—â–∏–π –∏–Ω–¥–µ–∫—Å
                titleInput.value = '';
                orderInput.value = parseInt(orderInput.value) + 1;

            } catch (error) {
                console.error('–û—à–∏–±–∫–∞ —Å–æ–∑–¥–∞–Ω–∏—è –º–æ–¥—É–ª—è:', error);
                alert(error.response?.data?.error || '–ù–µ —É–¥–∞–ª–æ—Å—å —Å–æ–∑–¥–∞—Ç—å –º–æ–¥—É–ª—å');
            }
        });


        loadCourseForEdit();
    </script>
</body>

</html>