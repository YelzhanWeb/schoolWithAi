<!DOCTYPE html>
<html lang="ru">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>–î–∞—à–±–æ—Ä–¥ - OqysAI</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/axios/dist/axios.min.js"></script>
</head>

<body class="bg-gray-50">
    <!-- Navbar -->
    <nav class="bg-white shadow-md">
        <div class="max-w-7xl mx-auto px-4 py-4">
            <div class="flex items-center justify-between">
                <h1 class="text-2xl font-bold text-indigo-600">üéì OqysAI</h1>
                <div class="flex items-center space-x-6">
                    <a href="./dashboard.html" class="text-indigo-600 font-semibold">–ì–ª–∞–≤–Ω–∞—è</a>
                    <a href="./recommendations.html" class="text-gray-600 hover:text-indigo-600">–†–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–∏</a>
                    <a href="./profile-setup.html" class="text-gray-600 hover:text-indigo-600">–ü—Ä–æ—Ñ–∏–ª—å</a>
                    <div class="flex items-center space-x-2">
                        <span class="text-gray-700" id="userName">–ó–∞–≥—Ä—É–∑–∫–∞...</span>
                        <button onclick="logout()" class="text-red-600 hover:text-red-700">–í—ã–π—Ç–∏</button>
                    </div>
                </div>
            </div>
        </div>
    </nav>

    <div class="max-w-7xl mx-auto px-4 py-8">
        <!-- Welcome Section -->
        <div class="mb-8">
            <h2 class="text-3xl font-bold text-gray-800 mb-2">–î–æ–±—Ä–æ –ø–æ–∂–∞–ª–æ–≤–∞—Ç—å! üëã</h2>
            <p class="text-gray-600">–ü—Ä–æ–¥–æ–ª–∂–∞–π –æ–±—É—á–µ–Ω–∏–µ –∏ –¥–æ—Å—Ç–∏–≥–∞–π –Ω–æ–≤—ã—Ö —Ü–µ–ª–µ–π</p>
        </div>

        <!-- Statistics Cards -->
        <div id="statistics" class="grid grid-cols-1 md:grid-cols-4 gap-6 mb-8">
            <!-- Will be loaded by JS -->
        </div>

        <!-- Top Recommendations -->
        <div class="bg-white rounded-lg shadow-md p-6 mb-8">
            <div class="flex items-center justify-between mb-4">
                <h3 class="text-xl font-bold text-gray-800">üìö –†–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–∏ –¥–ª—è —Ç–µ–±—è</h3>
                <a href="./recommendations.html" class="text-indigo-600 hover:text-indigo-700 font-semibold">
                    –í—Å–µ —Ä–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–∏ ‚Üí
                </a>
            </div>
            <div id="topRecommendations">
                <!-- Will be loaded by JS -->
            </div>
        </div>

        <!-- Recent Progress -->
        <div class="bg-white rounded-lg shadow-md p-6">
            <h3 class="text-xl font-bold text-gray-800 mb-4">üìä –¢–≤–æ–π –ø—Ä–æ–≥—Ä–µ—Å—Å</h3>
            <div id="recentProgress">
                <!-- Will be loaded by JS -->
            </div>
        </div>
    </div>

    <script src="js/api.js"></script>
    <script src="js/auth.js"></script>
    <script src="js/main.js"></script>
    <script>
        // Initialize
        initAuth();

        // Load dashboard data
        async function loadDashboard() {
            await Promise.all([
                loadStatistics(),
                loadTopRecommendations(),
                loadRecentProgress()
            ]);
        }

        // Load statistics
        async function loadStatistics() {
            try {
                const response = await API.progress.getStatistics();
                const stats = response.data;

                const statsHTML = `
                    <div class="bg-indigo-50 rounded-lg p-6">
                        <div class="text-indigo-600 text-sm font-semibold mb-2">–£–†–û–í–ï–ù–¨</div>
                        <div class="text-3xl font-bold text-indigo-700">${stats.level || 1}</div>
                        <div class="text-sm text-gray-600 mt-1">${stats.total_points || 0} –æ—á–∫–æ–≤</div>
                    </div>

                    <div class="bg-green-50 rounded-lg p-6">
                        <div class="text-green-600 text-sm font-semibold mb-2">–ó–ê–í–ï–†–®–ï–ù–û</div>
                        <div class="text-3xl font-bold text-green-700">${stats.completed_count || 0}</div>
                        <div class="text-sm text-gray-600 mt-1">–∏–∑ ${stats.total_resources || 0} —É—Ä–æ–∫–æ–≤</div>
                    </div>

                    <div class="bg-yellow-50 rounded-lg p-6">
                        <div class="text-yellow-600 text-sm font-semibold mb-2">–°–†–ï–î–ù–ò–ô –ë–ê–õ–õ</div>
                        <div class="text-3xl font-bold text-yellow-700">${Math.round(stats.average_score || 0)}%</div>
                        <div class="text-sm text-gray-600 mt-1">—É—Å–ø–µ–≤–∞–µ–º–æ—Å—Ç—å</div>
                    </div>

                    <div class="bg-blue-50 rounded-lg p-6">
                        <div class="text-blue-600 text-sm font-semibold mb-2">–í–†–ï–ú–Ø –û–ë–£–ß–ï–ù–ò–Ø</div>
                        <div class="text-3xl font-bold text-blue-700">${formatTime(stats.total_time_spent || 0)}</div>
                        <div class="text-sm text-gray-600 mt-1">–≤—Å–µ–≥–æ –≤—Ä–µ–º–µ–Ω–∏</div>
                    </div>
                `;

                document.getElementById('statistics').innerHTML = statsHTML;
            } catch (error) {
                console.error('Error loading statistics:', error);
            }
        }

        // Load top recommendations
        async function loadTopRecommendations() {
            showLoading('topRecommendations');

            try {
                const response = await API.recommendations.get();
                const recommendations = response.data.recommendations || response.data;

                if (!recommendations || recommendations.length === 0) {
                    document.getElementById('topRecommendations').innerHTML = `
                        <p class="text-gray-500 text-center py-4">–ü–æ–∫–∞ –Ω–µ—Ç —Ä–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–π</p>
                    `;
                    return;
                }

                const topRecs = recommendations.slice(0, 5);
                const recsHTML = topRecs.map((rec, index) => `
                    <div class="border-b last:border-b-0 py-4 hover:bg-gray-50 transition">
                        <div class="flex items-start justify-between">
                            <div class="flex-1">
                                <div class="flex items-center space-x-2 mb-2">
                                    <span class="text-2xl">${index + 1}</span>
                                    <h4 class="font-semibold text-gray-800">${rec.title}</h4>
                                </div>
                                <p class="text-sm text-gray-600 mb-2">${rec.reason}</p>
                                <div class="flex items-center space-x-2">
                                    <span class="text-xs px-2 py-1 bg-indigo-100 text-indigo-700 rounded">
                                        Score: ${(rec.score * 100).toFixed(0)}%
                                    </span>
                                    <span class="text-xs text-gray-500">${rec.algorithm}</span>
                                </div>
                            </div>
                            <a href="./course-detail.html?id=${rec.course_id}" // <-- –ù–û–í–ê–Ø –°–¢–†–û–ö–ê
                                class="ml-4 px-4 py-2 bg-indigo-600 text-white rounded-lg hover:bg-indigo-700 transition">
                                 –û—Ç–∫—Ä—ã—Ç—å –∫—É—Ä—Å
                            </a>
                        </div>
                    </div>
                `).join('');

                document.getElementById('topRecommendations').innerHTML = recsHTML;
            } catch (error) {
                showError('topRecommendations', '–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ —Ä–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–π');
            }
        }

        // Load recent progress
        async function loadRecentProgress() {
            showLoading('recentProgress');

            try {
                const response = await API.progress.get();
                const progress = response.data.progress || response.data;

                if (!progress || progress.length === 0) {
                    document.getElementById('recentProgress').innerHTML = `
                        <p class="text-gray-500 text-center py-4">–ù–∞—á–Ω–∏ —Å–≤–æ—ë –ø–µ—Ä–≤–æ–µ –æ–±—É—á–µ–Ω–∏–µ!</p>
                    `;
                    return;
                }

                const recentProgress = progress.slice(0, 5);
                const progressHTML = recentProgress.map(p => `
                    <div class="border-b last:border-b-0 py-3 flex items-center justify-between">
                        <div class="flex-1">
                            <div class="font-semibold text-gray-800">Resource ID: ${p.resource_id}</div>
                            <div class="text-sm text-gray-600">
                                –°—Ç–∞—Ç—É—Å: <span class="font-semibold">${p.status}</span> 
                                | –ë–∞–ª–ª: ${p.score}%
                                | –í—Ä–µ–º—è: ${formatTime(p.time_spent)}
                            </div>
                        </div>
                        ${p.status === 'completed' ?
                        '<span class="text-green-600 font-semibold">‚úì –ó–∞–≤–µ—Ä—à–µ–Ω–æ</span>' :
                        '<span class="text-yellow-600 font-semibold">‚è≥ –í –ø—Ä–æ—Ü–µ—Å—Å–µ</span>'}
                    </div>
                `).join('');

                document.getElementById('recentProgress').innerHTML = progressHTML;
            } catch (error) {
                showError('recentProgress', '–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –ø—Ä–æ–≥—Ä–µ—Å—Å–∞');
            }
        }

        // Load on page ready
        loadDashboard();
    </script>
</body>

</html>